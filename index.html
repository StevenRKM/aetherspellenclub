<!DOCTYPE html>
<html>
<head>
    <title>Aether Spellenclub</title>
    <script src="jquery-2.0.3.min.js" type="text/javascript"></script>
    <script>

    var guild = undefined;

    $(function() {
        load_guild();
    });

    /* -- LOAD FROM BGG API -- */

    function load_guild() {

        console.log('loading guild');

        // super var
        guild = {
            members: [],
            games: {}
        };

        $.ajax({
            url: '/bggapi/xmlapi2/guild?id=1576&members=1',
            contentType: "application/xml; charset=utf-8",
            dataType: "xml"
        }).success(function(data){

            console.log('loaded guild');

            var members = $(data).find('member');

            for (var i = 0; i < members.length; i++) {
                var member = {
                    id: undefined,
                    username: members[i].getAttribute('name'),
                    firstname: undefined,
                    lastname: undefined,
                    collection: []
                };

                guild.members.push(member);

                load_member_collection(member);
            }

        }).error(function(data){
            console.log('woops, couldn\'t load guild');
        });

    }


    function load_member_collection(member) {

        $.ajax({
            url: '/bggapi/xmlapi2/collection?username='+member.username+'&own=1',
            contentType: "application/xml; charset=utf-8",
            dataType: "xml"
        }).success(function(data){

            console.log('loading guild member collection of '+member.username);

            var items = $(data).find('item')
            for (var i = 0; i < items.length; i++) {

                // add game to collection
                var id = $(items[i]).attr('objectid');

                member.collection.push(id);

                if(guild.games[id] == undefined) {
                    guild.games[id] = {
                        id: id,
                        name: $(items[i]).find('name').text(),
                        image: $(items[i]).find('image').text(),
                        thumbnail: $(items[i]).find('thumbnail').text()
                    }
                } else {
                    console.log('double found for '+member.username+' on '+$(items[i]).find('name').text());
                }

            }

            load_member_name(member);

        }).error(function(data){
            console.log('woops, couldn\'t load member collection of '+member.username);
        });


    }

    function load_member_name(member) {

        $.ajax({
            url: '/bggapi/xmlapi2/user?name='+member.username,
            contentType: "application/xml; charset=utf-8",
            dataType: "xml"
        }).success(function(data){

            console.log('loading guild member info of '+member.username);

            member.firstname = $(data).find('firstname').attr('value');
            member.lastname = $(data).find('lastname').attr('value');

            display_member_collection(member)

        }).error(function(data){
            console.log('woops, couldn\'t load member info of '+member.username);
        });

    }


    /* -- DISPLAY -- */

    function display_member_collection(member) {

        var collection = $('<div id='+member.username+'><h2>'+member.firstname+' '+member.lastname+'</h2><br /><div></div></div>');

        for (var i = 0; i < member.collection.length; i++) {

            var id = member.collection[i];
            var game = guild.games[id];

            collection.find('div').append(
                    $('<img />', {src: game.thumbnail})
            );
        }

        collection.appendTo('#collections');

    }

    </script>

</head>
<body>

<div id="collections"></div>

<div id="images"></div>

</body>
</html>